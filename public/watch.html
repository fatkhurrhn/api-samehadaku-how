<!-- /public/watch.html -->
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Anime - YLnime</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- HLS.js untuk streaming .m3u8 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 Aspect Ratio */
            background: #000;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        #video-player,
        #player-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 15;
        }

        #video-player {
            object-fit: contain;
            background: #000;
        }

        #video-player::-webkit-media-controls {
            z-index: 30;
        }

        #video-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .loader-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .watermark {
            position: absolute;
            bottom: 15px;
            right: 20px;
            color: rgba(255, 255, 255, 0.3);
            font-weight: bold;
            z-index: 25;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .server-btn {
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }

        .dark .server-btn {
            border-color: #334155;
        }

        .server-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .server-btn.active {
            background: #6366f1 !important;
            color: white !important;
            border-color: #6366f1 !important;
        }

        .resolution-btn.active {
            background: #6366f1 !important;
            color: white !important;
            border-color: #6366f1 !important;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors font-sans antialiased">
    <!-- Navbar -->
    <nav
        class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <a href="/" class="text-2xl font-bold text-indigo-500 flex items-center gap-2">
                    <i class="fas fa-play-circle"></i>
                    <span>YLnime</span>
                </a>
                <div class="flex items-center gap-3">
                    <button id="themeToggle"
                        class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition"
                        title="Toggle theme">
                        <i class="fas fa-moon text-slate-600 dark:text-slate-300" id="theme-icon"></i>
                    </button>
                    <a href="/"
                        class="px-4 py-2 bg-indigo-500 text-white rounded-full text-sm hover:bg-indigo-600 transition shadow-md hover:shadow-lg flex items-center gap-2">
                        <i class="fas fa-home"></i>
                        <span class="hidden sm:inline">Home</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Back Button -->
    <div class="container mx-auto px-4 py-4">
        <button onclick="history.back()"
            class="flex items-center gap-2 text-indigo-500 hover:text-indigo-600 transition group">
            <i class="fas fa-arrow-left group-hover:-translate-x-1 transition"></i>
            <span>Kembali ke Detail</span>
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-12 hidden">
        <div class="spinner mx-auto"></div>
        <p class="mt-4 text-slate-500">Memuat video...</p>
    </div>

    <!-- Error Message -->
    <div id="error" class="hidden container mx-auto px-4 mb-4">
        <div
            class="bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg flex items-center gap-3">
            <i class="fas fa-exclamation-circle"></i>
            <span id="error-message"></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <div id="content" class="hidden">
            <!-- Title -->
            <h1 id="anime-title"
                class="text-2xl md:text-3xl font-bold mb-4 bg-gradient-to-r from-indigo-500 to-purple-600 bg-clip-text text-transparent">
            </h1>

            <!-- Video Player Section -->
            <div class="video-container mb-4 shadow-2xl border-2 border-slate-200 dark:border-slate-700">
                <!-- Loading Spinner -->
                <div id="video-loader" class="loader-hidden">
                    <div class="text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-white text-sm">Memuat video...</p>
                        <p class="text-white/50 text-xs mt-2">Harap tunggu sebentar</p>
                    </div>
                </div>

                <!-- HTML5 Video Player (for MP4) -->
                <video id="video-player" class="w-full h-full" controls style="display: none;" preload="auto">
                    <source src="" type="video/mp4">
                    <p class="text-white p-4">Browser kamu tidak mendukung video tag.</p>
                </video>

                <!-- Iframe Player (for YouTube, Pixeldrain, etc) -->
                <iframe id="player-frame" class="w-full h-full" src="" allowfullscreen style="display: none;"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>

                <!-- Watermark -->
                <div class="watermark">
                    YLnime<span class="text-orange-400">.com</span>
                </div>
            </div>

            <!-- Episode Navigation -->
            <div class="flex flex-wrap justify-between items-center gap-3 mb-6">
                <button id="prev-btn"
                    class="px-6 py-2.5 bg-indigo-500 text-white rounded-full text-sm hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2 shadow-md hover:shadow-lg"
                    disabled>
                    <i class="fas fa-backward"></i>
                    <span class="hidden sm:inline">Episode Sebelumnya</span>
                    <span class="sm:hidden">Sebelumnya</span>
                </button>

                <span id="episode-info"
                    class="text-sm bg-slate-200 dark:bg-slate-700 px-4 py-2 rounded-full font-medium shadow-sm">
                    Memuat...
                </span>

                <button id="next-btn"
                    class="px-6 py-2.5 bg-indigo-500 text-white rounded-full text-sm hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2 shadow-md hover:shadow-lg"
                    disabled>
                    <span class="hidden sm:inline">Episode Selanjutnya</span>
                    <span class="sm:hidden">Selanjutnya</span>
                    <i class="fas fa-forward"></i>
                </button>
            </div>

            <!-- Video Controls Card -->
            <div
                class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6 mb-6 shadow-lg">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Resolutions -->
                    <div>
                        <h6 class="font-semibold mb-3 flex items-center gap-2 text-indigo-500">
                            <i class="fas fa-cog"></i>
                            <span>Resolusi</span>
                        </h6>
                        <div id="resolution-list" class="flex flex-wrap gap-2">
                            <!-- Will be filled by JavaScript -->
                        </div>
                    </div>

                    <!-- Servers -->
                    <div>
                        <h6 class="font-semibold mb-3 flex items-center gap-2 text-indigo-500">
                            <i class="fas fa-server"></i>
                            <span>Server Video</span>
                        </h6>
                        <div id="server-list" class="flex flex-wrap gap-2">
                            <!-- Will be filled by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <div
                class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-6 shadow-lg">
                <h5 class="font-bold mb-4 flex items-center gap-2 text-indigo-500">
                    <i class="fas fa-info-circle"></i>
                    <span>Informasi Episode</span>
                </h5>
                <div id="episode-info-detail" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <!-- Will be filled by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-slate-500 dark:text-slate-400 text-sm">
            <p>¬© 2026 YLnime. All rights reserved. | Fan Project</p>
            <p class="text-xs mt-2">Disclaimer: This site does not host any files on its server.</p>
        </div>
    </footer>

    <script>
        // ==================== THEME TOGGLE ====================
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('theme-icon');
        const html = document.documentElement;

        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            html.classList.add('dark');
            themeIcon.className = 'fas fa-sun';
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        });

        // ==================== GET URL PARAMS ====================
        const urlParams = new URLSearchParams(window.location.search);
        const series = urlParams.get('series');
        const episode = urlParams.get('episode');

        if (!series || !episode) {
            window.location.href = '/';
        }

        // ==================== DOM ELEMENTS ====================
        const loader = document.getElementById('video-loader');
        const videoPlayer = document.getElementById('video-player');
        const playerFrame = document.getElementById('player-frame');
        const animeTitle = document.getElementById('anime-title');
        const episodeInfo = document.getElementById('episode-info');
        const episodeInfoDetail = document.getElementById('episode-info-detail');
        const resolutionList = document.getElementById('resolution-list');
        const serverList = document.getElementById('server-list');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        const content = document.getElementById('content');

        // ==================== HELPER FUNCTIONS ====================
        function showLoading(show) {
            if (show) {
                loader.classList.remove('loader-hidden');
                videoPlayer.style.opacity = '0.3';
                playerFrame.style.opacity = '0.3';
            } else {
                loader.classList.add('loader-hidden');
                videoPlayer.style.opacity = '1';
                playerFrame.style.opacity = '1';
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // ==================== VIDEO LOADER FUNCTION ====================
        function loadVideo(url) {
            if (!url) {
                showError('URL video tidak tersedia');
                return;
            }

            console.log('üé¨ Loading video from:', url);
            showLoading(true);

            // Sembunyikan semua player
            videoPlayer.style.display = 'none';
            playerFrame.style.display = 'none';

            // Stop video yang sedang playing
            videoPlayer.pause();
            videoPlayer.src = '';
            playerFrame.src = '';

            // Deteksi tipe URL
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                // YouTube
                console.log('üì∫ YouTube detected');
                let videoId;
                if (url.includes('youtu.be')) {
                    videoId = url.split('/').pop().split('?')[0];
                } else {
                    videoId = new URL(url).searchParams.get('v');
                }

                if (videoId) {
                    playerFrame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
                    playerFrame.style.display = 'block';
                } else {
                    showError('Invalid YouTube URL');
                }
            } else if (url.includes('pixeldrain.com')) {
                // Pixeldrain
                console.log('üì∫ Pixeldrain detected');
                const fileId = url.split('/').pop().replace('?download', '');
                playerFrame.src = `https://pixeldrain.com/u/${fileId}`;
                playerFrame.style.display = 'block';
            } else if (url.includes('.mp4') || url.includes('.mkv') || url.includes('.webm') || url.includes('storage.animekita')) {
                // Video file - gunakan HTML5 video player
                console.log('üì∫ MP4/Video file detected');
                videoPlayer.style.display = 'block';

                // Set source dan load
                const source = videoPlayer.querySelector('source');
                source.src = url;
                videoPlayer.load();

                // Autoplay dengan error handling
                const playPromise = videoPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Autoplay prevented:', error);
                    });
                }

                // Event listener untuk hide loader saat video siap
                videoPlayer.oncanplay = () => {
                    console.log('‚úÖ Video can play');
                    showLoading(false);
                };

                videoPlayer.onerror = (e) => {
                    console.error('‚ùå Video error:', e);
                    showError('Gagal memuat video. Coba server lain.');
                    showLoading(false);
                };
            } else if (url.includes('.m3u8')) {
                // HLS stream
                console.log('üì∫ HLS stream detected');

                // Cek apakah browser support HLS
                if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari native HLS
                    videoPlayer.style.display = 'block';
                    const source = videoPlayer.querySelector('source');
                    source.src = url;
                    source.type = 'application/vnd.apple.mpegurl';
                    videoPlayer.load();
                    videoPlayer.play().catch(() => { });
                } else if (Hls.isSupported()) {
                    // Gunakan HLS.js
                    videoPlayer.style.display = 'block';
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        videoPlayer.play().catch(() => { });
                    });
                } else {
                    // Fallback ke iframe
                    playerFrame.src = `https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls-demo.html?src=${encodeURIComponent(url)}`;
                    playerFrame.style.display = 'block';
                }
            } else {
                // Default - coba sebagai iframe
                console.log('üì∫ Generic iframe');
                playerFrame.src = url;
                playerFrame.style.display = 'block';
            }

            // Safety timeout untuk hide loader
            setTimeout(() => showLoading(false), 5000);
        }

        // ==================== FETCH WATCH DATA ====================
        async function fetchWatch() {
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            content.classList.add('hidden');

            try {
                const response = await fetch(`/api/watch?series=${encodeURIComponent(series)}&episode=${encodeURIComponent(episode)}`);
                const result = await response.json();

                console.log('üì¶ API Response:', result);

                if (!result.success) throw new Error(result.error || 'Gagal memuat data');

                renderData(result);

            } catch (error) {
                console.error('‚ùå Error:', error);
                errorMessage.textContent = error.message;
                errorDiv.classList.remove('hidden');

                // Fallback untuk testing
                if (series === 'si-vis-sub-indo' && episode === 'al-150546-18') {
                    useFallbackData();
                }
            } finally {
                loading.classList.add('hidden');
            }
        }

        // ==================== FALLBACK DATA ====================
        function useFallbackData() {
            console.log('üì¶ Using fallback data');

            const fallbackData = {
                success: true,
                title: 'SI-VIS: The Sound of Heroes Episode 18 - YLnime Sub Indo',
                episode: {
                    current: { series, episode },
                    previous: { series: 'si-vis-sub-indo', episode: 'al-150546-17' },
                    next: { series: 'si-vis-sub-indo', episode: 'al-150546-19' }
                },
                video: {
                    streams: [
                        {
                            resolution: '720p',
                            url: 'https://storage.animekita.org/ro/3337-1770538085203.mp4',
                            provider: 'animekita'
                        }
                    ],
                    resolutions: [
                        { resolution: '360p', active: false },
                        { resolution: '480p', active: false },
                        { resolution: '720p', active: true },
                        { resolution: '1080p', active: false }
                    ]
                },
                info: {
                    release: '2026',
                    genre: 'Action, Fantasy',
                    duration: '24 min'
                }
            };

            renderData(fallbackData);
        }

        // ==================== RENDER DATA ====================
        function renderData(data) {
            // Set title
            animeTitle.textContent = data.title || 'Streaming Anime';

            // Episode info
            const episodeNumber = episode.replace('al-150546-', '');
            episodeInfo.textContent = `Episode ${episodeNumber}`;

            // Episode navigation
            if (data.episode?.previous) {
                prevBtn.disabled = false;
                prevBtn.onclick = () => {
                    window.location.href = `/watch?series=${data.episode.previous.series}&episode=${data.episode.previous.episode}`;
                };
            } else {
                prevBtn.disabled = true;
            }

            if (data.episode?.next) {
                nextBtn.disabled = false;
                nextBtn.onclick = () => {
                    window.location.href = `/watch?series=${data.episode.next.series}&episode=${data.episode.next.episode}`;
                };
            } else {
                nextBtn.disabled = true;
            }

            // Episode detail info
            episodeInfoDetail.innerHTML = `
                <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
                    <span class="text-xs text-slate-500 dark:text-slate-400 block">Series</span>
                    <span class="font-medium">${series}</span>
                </div>
                <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
                    <span class="text-xs text-slate-500 dark:text-slate-400 block">Episode</span>
                    <span class="font-medium">${episodeNumber}</span>
                </div>
                <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
                    <span class="text-xs text-slate-500 dark:text-slate-400 block">Server</span>
                    <span class="font-medium">${data.video?.streams?.length || 0} Tersedia</span>
                </div>
                <div class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
                    <span class="text-xs text-slate-500 dark:text-slate-400 block">Rilis</span>
                    <span class="font-medium">${data.info?.release || '2026'}</span>
                </div>
            `;

            // Resolutions
            resolutionList.innerHTML = '';
            const resolutions = data.video?.resolutions || [
                { resolution: '360p', active: false },
                { resolution: '480p', active: false },
                { resolution: '720p', active: true },
                { resolution: '1080p', active: false }
            ];

            resolutions.forEach(res => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 rounded-lg border transition-all text-sm resolution-btn ${res.active ? 'active' : 'border-slate-300 dark:border-slate-600 hover:bg-indigo-500 hover:text-white hover:border-indigo-500'}`;
                btn.textContent = res.resolution;
                resolutionList.appendChild(btn);
            });

            // Servers
            serverList.innerHTML = '';
            const streams = data.video?.streams || [];

            if (streams.length === 0) {
                serverList.innerHTML = '<p class="text-sm text-slate-500">Tidak ada server tersedia</p>';
            } else {
                streams.forEach((stream, index) => {
                    const btn = document.createElement('button');
                    btn.className = `px-4 py-2 rounded-lg border transition-all text-sm server-btn ${index === 0 ? 'active bg-indigo-500 text-white border-indigo-500' : 'border-slate-300 dark:border-slate-600 hover:bg-indigo-500 hover:text-white hover:border-indigo-500'}`;

                    // Custom server name
                    let serverName = stream.provider || `Server ${index + 1}`;
                    if (serverName.includes('animekita')) serverName = 'AnimeKita';
                    else if (serverName.includes('pixeldrain')) serverName = 'Pixeldrain';
                    else if (serverName.includes('mp4')) serverName = 'Direct MP4';
                    else if (serverName.includes('ylnime')) serverName = 'YLnime Server';

                    btn.textContent = serverName;

                    btn.onclick = () => {
                        document.querySelectorAll('.server-btn').forEach(b => {
                            b.classList.remove('active', 'bg-indigo-500', 'text-white', 'border-indigo-500');
                            b.classList.add('border-slate-300', 'dark:border-slate-600', 'hover:bg-indigo-500', 'hover:text-white', 'hover:border-indigo-500');
                        });
                        btn.classList.add('active', 'bg-indigo-500', 'text-white', 'border-indigo-500');
                        loadVideo(stream.url);
                    };

                    serverList.appendChild(btn);
                });

                // Auto-load first stream
                if (streams[0]?.url) {
                    setTimeout(() => {
                        loadVideo(streams[0].url);
                    }, 500);
                }
            }

            content.classList.remove('hidden');
        }

        // ==================== INITIALIZE ====================
        document.addEventListener('DOMContentLoaded', fetchWatch);

        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            window.location.reload();
        });

        // Error handling untuk video player
        videoPlayer.addEventListener('error', (e) => {
            console.error('Video player error:', e);
            showError('Gagal memuat video. Mencoba server lain...');
            showLoading(false);

            // Coba server berikutnya jika ada
            const serverBtns = document.querySelectorAll('.server-btn');
            for (let btn of serverBtns) {
                if (!btn.classList.contains('active')) {
                    btn.click();
                    break;
                }
            }
        });

        // Log saat video siap
        videoPlayer.addEventListener('loadeddata', () => {
            console.log('‚úÖ Video loaded successfully');
            showLoading(false);
        });

        // Handle iframe load
        playerFrame.addEventListener('load', () => {
            console.log('‚úÖ Iframe loaded');
            showLoading(false);
        });

        playerFrame.addEventListener('error', () => {
            console.error('‚ùå Iframe error');
            showError('Gagal memuat iframe player');
            showLoading(false);
        });
    </script>
</body>

</html>